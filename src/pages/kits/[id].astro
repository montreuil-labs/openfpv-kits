---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { deriveRequirements, packItemIds } from '../../lib/derived';
import {
  getChecklistById,
  getItemById,
  getNotesById,
  getPackById,
  getPackList,
} from '../../lib/data';

export function getStaticPaths() {
  return getPackList().map((pack) => ({ params: { id: pack.id } }));
}

const { id } = Astro.params;
const pack = id ? getPackById(id) : null;

if (!pack) {
  throw new Error(`Unknown pack id: ${id}`);
}

const itemIds = packItemIds(pack);
const requirements = deriveRequirements(itemIds);
const checklist = pack.checklist_refs[0] ? getChecklistById(pack.checklist_refs[0]) : null;
const notes = pack.notes_ref ? getNotesById(pack.notes_ref) : null;

const itemEntries = Object.entries(pack.items)
  .flatMap(([key, value]) => {
    if (!value) return [];
    if (Array.isArray(value)) return value.map((id) => ({ key, id }));
    return [{ key, id: value }];
  })
  .filter(Boolean);

const formatRange = (values: [number, number]) => `$${Math.round(values[0])} – $${Math.round(values[1])}`;
---

<BaseLayout title={`${pack.title} | OpenFPV Kits`} description={pack.pitch.best_for.join(', ')}>
  <div class="card space-y-3">
    <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
      <div>
        <p class="text-sm text-[--color-muted]">Starter kit</p>
        <h1 class="text-3xl font-bold leading-tight">{pack.title}</h1>
        <p class="text-sm text-[--color-muted]">{pack.form_factor} • {pack.video_system} • {pack.skill_level.replace('_', ' ')}</p>
      </div>
      <div class="text-right">
        <div class="text-sm text-[--color-muted]">Typical total</div>
        <div class="text-xl font-semibold">{formatRange(pack.est_total.typical_range)}</div>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="btn" href={`/builder?seed=${pack.id}`}>Open in builder</a>
      <a class="btn secondary" href={`/kits`}>All kits</a>
      <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/issues/new?title=Feedback:%20${encodeURIComponent(pack.title)}`}>Suggest changes</a>
    </div>
  </div>

  <div class="mt-4 grid gap-4 lg:grid-cols-2">
    <section class="card space-y-3">
      <h2 class="text-lg font-semibold">What you’re buying</h2>
      <div class="space-y-3">
        {itemEntries.map(({ key, id }) => {
          const item = getItemById(id);
          if (!item) return null;
          return (
            <div class="rounded-xl border border-[--color-border] bg-[--color-surface-muted] px-3 py-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <p class="text-xs uppercase tracking-wide text-[--color-muted]">{key}</p>
                  <p class="font-semibold">{item.title}</p>
                  <p class="text-sm text-[--color-muted]">{item.summary}</p>
                </div>
                <div class="text-sm font-semibold">{formatRange(item.price.typical_range)}</div>
              </div>
              {item.requires?.length ? (
                <p class="mt-2 text-xs text-[--color-muted]">Requires: {item.requires.map((r) => r.title).join(', ')}</p>
              ) : null}
            </div>
          );
        })}
      </div>
    </section>

    <section class="card space-y-3">
      <h2 class="text-lg font-semibold">Upgrade paths</h2>
      {pack.upgrade_paths.length ? (
        <div class="space-y-3">
          {pack.upgrade_paths.map((upgrade) => (
            <div class="rounded-xl border border-[--color-border] p-3">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="font-semibold">{upgrade.title}</p>
                  <p class="text-sm text-[--color-muted]">{upgrade.why}</p>
                </div>
                <div class="text-sm font-semibold">+{formatRange(upgrade.delta_usd_typical)}</div>
              </div>
              {upgrade.change.replace ? (
                <p class="mt-2 text-sm text-[--color-muted]">
                  Replaces: {Object.entries(upgrade.change.replace)
                    .map(([slot, val]) => `${slot} → ${typeof val === 'string' ? val : 'update'}`)
                    .join(', ')}
                </p>
              ) : null}
              {upgrade.change.note ? <p class="mt-1 text-sm text-[--color-muted]">{upgrade.change.note}</p> : null}
              <a class="btn secondary mt-3 inline-flex" href={`/builder?seed=${pack.id}&apply=${upgrade.id}`}>
                Open in builder
              </a>
            </div>
          ))}
        </div>
      ) : (
        <p class="text-sm text-[--color-muted]">No curated upgrades yet.</p>
      )}
    </section>
  </div>

  <section class="mt-4 grid gap-4 lg:grid-cols-2">
    <div class="card space-y-3">
      <h2 class="text-lg font-semibold">Requirements (don’t forget these)</h2>
      {requirements.length ? (
        <ul class="list-disc space-y-1 pl-5 text-sm text-[--color-muted]">
          {requirements.map((r) => (
            <li>
              {r.kind === 'battery' ? `${r.qty ? `${r.qty}× ` : ''}${r.title}` : r.title}
              {r.notes ? ` — ${r.notes}` : ''}
            </li>
          ))}
        </ul>
      ) : (
        <p class="text-sm text-[--color-muted]">No extra requirements detected.</p>
      )}
    </div>

    <div class="card space-y-3">
      <h2 class="text-lg font-semibold">Setup checklist</h2>
      {checklist ? (
        <div class="space-y-4">
          {checklist.groups.map((group) => (
            <div class="space-y-2">
              <p class="font-semibold">{group.title}</p>
              <ul class="space-y-1 text-sm text-[--color-muted]">
                {group.items.map((item) => (
                  <li class="flex items-start gap-2">
                    <span class="mt-1 inline-block h-2 w-2 rounded-full bg-[--color-accent]"></span>
                    <span>{item.text}</span>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      ) : (
        <p class="text-sm text-[--color-muted]">No checklist yet.</p>
      )}
    </div>
  </section>

  <section class="mt-4 grid gap-4 lg:grid-cols-2">
    <div class="card space-y-3">
      <h2 class="text-lg font-semibold">Community notes</h2>
      {notes ? (
        <div class="space-y-2 text-sm text-[--color-muted]">
          {notes.substitutes.length ? (
            <div>
              <p class="font-semibold text-[--color-ink]">Common substitutes</p>
              <ul class="list-disc space-y-1 pl-5">
                {notes.substitutes.map((n) => (
                  <li>{n.text}</li>
                ))}
              </ul>
            </div>
          ) : null}
          {notes.pitfalls.length ? (
            <div>
              <p class="font-semibold text-[--color-ink]">Known pitfalls</p>
              <ul class="list-disc space-y-1 pl-5">
                {notes.pitfalls.map((n) => (
                  <li>{n.text}</li>
                ))}
              </ul>
            </div>
          ) : null}
          {notes.regrets.length ? (
            <div>
              <p class="font-semibold text-[--color-ink]">What people regret</p>
              <ul class="list-disc space-y-1 pl-5">
                {notes.regrets.map((n) => (
                  <li>{n.text}</li>
                ))}
              </ul>
            </div>
          ) : null}
          {notes.tips.length ? (
            <div>
              <p class="font-semibold text-[--color-ink]">Tips</p>
              <ul class="list-disc space-y-1 pl-5">
                {notes.tips.map((n) => (
                  <li>{n.text}</li>
                ))}
              </ul>
            </div>
          ) : null}
        </div>
      ) : (
        <p class="text-sm text-[--color-muted]">No notes yet.</p>
      )}
      <div class="flex flex-wrap gap-2">
        <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/issues/new?title=Note:%20${encodeURIComponent(pack.title)}`}>Add a note</a>
        <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/discussions`}>Discuss</a>
      </div>
    </div>

    <div class="card space-y-3">
      <h2 class="text-lg font-semibold">Contribute</h2>
      <div class="flex flex-wrap gap-2">
        <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/edit/main/src/data/packs/${pack.id}.yml`} target="_blank">Edit this kit</a>
        <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/issues/new?title=Kit%20feedback:%20${encodeURIComponent(pack.title)}`} target="_blank">Open issue</a>
      </div>
    </div>
  </section>
</BaseLayout>
