---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCatalogList, getItemById } from '../../lib/data';

export function getStaticPaths() {
  return getCatalogList().map((item) => ({ params: { id: item.id } }));
}

const { id } = Astro.params;
const item = id ? getItemById(id) : null;

if (!item) {
  throw new Error(`Unknown item id: ${id}`);
}

const formatRange = (values: [number, number]) => `$${Math.round(values[0])} – $${Math.round(values[1])}`;
---

<BaseLayout title={`${item.title} | Catalog`} description={item.summary}>
  <div class="card space-y-3">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-sm text-[--color-muted]">{item.type}</p>
        <h1 class="text-2xl font-bold leading-tight">{item.title}</h1>
        <p class="text-sm text-[--color-muted]">{item.summary}</p>
      </div>
      <p class="text-lg font-semibold">{formatRange(item.price.typical_range)}</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="btn secondary" href={`https://github.com/montreuil-labs/openfpv-kits/edit/main/src/data/catalog/items/${item.id}.yml`} target="_blank">Edit item</a>
      {item.links?.official ? <a class="btn secondary" href={item.links.official} target="_blank">Official</a> : null}
      {item.links?.search ? <a class="btn secondary" href={item.links.search} target="_blank">Search</a> : null}
    </div>
  </div>

  <div class="mt-4 grid gap-4 lg:grid-cols-2">
    <section class="card space-y-2">
      <h2 class="text-lg font-semibold">Requirements</h2>
      {item.requires?.length ? (
        <ul class="list-disc space-y-1 pl-5 text-sm text-[--color-muted]">
          {item.requires.map((req) => (
            <li>
              {req.kind === 'battery' ? `${req.qty ? `${req.qty}× ` : ''}${req.title}` : req.title}
              {req.notes ? ` — ${req.notes}` : ''}
            </li>
          ))}
        </ul>
      ) : (
        <p class="text-sm text-[--color-muted]">No additional requirements listed.</p>
      )}
    </section>

    <section class="card space-y-2">
      <h2 class="text-lg font-semibold">Included</h2>
      {item.includes?.length ? (
        <ul class="list-disc space-y-1 pl-5 text-sm text-[--color-muted]">
          {item.includes.map((inc) => (
            <li>
              {'qty' in inc && inc.qty ? `${inc.qty}× ` : ''}{inc.title}
              {inc.notes ? ` — ${inc.notes}` : ''}
            </li>
          ))}
        </ul>
      ) : (
        <p class="text-sm text-[--color-muted]">No included items listed.</p>
      )}
    </section>


    <section class="card space-y-2">
      <h2 class="text-lg font-semibold">Included</h2>
      {item.includes?.length ? (
        <ul class="list-disc space-y-1 pl-5 text-sm text-[--color-muted]">
          {item.includes.map((inc, idx) => (
            <li key={`${inc.title}-${idx}`}>
              {inc.qty ? `${inc.qty}× ` : ''}{inc.title}
              {inc.notes ? ` — ${inc.notes}` : ''}
            </li>
          ))}
        </ul>
      ) : (
        <p class="text-sm text-[--color-muted]">No included items listed.</p>
      )}
    </section>
  </div>

  {item.battery_options?.length ? (
    <section class="mt-4 card space-y-3">
      <h2 class="text-lg font-semibold">Battery options</h2>
      <div class="grid gap-2 md:grid-cols-2">
        {item.battery_options.map((batt) => (
          <div key={batt.title} class="rounded-lg border border-[--color-border] p-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="font-semibold">{batt.title}</p>
                {batt.notes ? <p class="text-sm text-[--color-muted]">{batt.notes}</p> : null}
              </div>
              {batt.typical_range_usd ? <p class="text-sm font-semibold">{formatRange(batt.typical_range_usd)}</p> : null}
            </div>
          </div>
        ))}
      </div>
    </section>
  ) : null}

  <section class="mt-4 card space-y-2">
    <h2 class="text-lg font-semibold">Also see</h2>
    {item.also_see?.length ? (
      <div class="flex flex-wrap gap-2">
        {item.also_see.map((id) => (
          <a key={id} class="btn secondary" href={`/catalog/${id}`}>
            {id}
          </a>
        ))}
      </div>
    ) : (
      <p class="text-sm text-[--color-muted]">No cross-links yet.</p>
    )}
  </section>
</BaseLayout>
